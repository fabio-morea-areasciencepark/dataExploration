---
output:
  pdf_document: default
  html_document: default
---
# Exploring dataset of companies in fvg {-}

This example is based on a data set curated by Area Science Park. More info: www.innovationintelligence.it
Data sources: infocamere, modefinance, accredia.


```{r include=FALSE}
# hidden code chunk: listing .csv files available in  subdirectory
# change of directory is valid only within this code chink
getwd()
setwd("./../_DATA")
print ("Modified working directory")
getwd()
data_files = list.files(pattern = ".csv$", recursive = TRUE)
data_files
```
 
 
```{r}
setwd("./../_DATA/infocamere")
imprese <- read.csv( "t_imprese.csv", sep = "|")
imprese <- imprese[!grepl('INATTIVA', imprese$stato_impresa),]
imprese$prov          <- as.factor(imprese$prov)
imprese$imp_pmi       <- as.factor(imprese$imp_pmi)
imprese$imp_startup   <- as.factor(imprese$imp_startup)
imprese$imp_giovanile <- as.factor(imprese$imp_giovanile)
imprese$imp_femminile <- as.factor(imprese$imp_femminile)
imprese$imp_straniera <- as.factor(imprese$imp_straniera)
imprese$imp_sedi_ee   <- as.factor(imprese$imp_sedi_ee)
imprese$ng2           <- as.factor(imprese$ng2)

```



```{r}
imprese$data_cost   <- as.Date(imprese$data_cost)
imprese$data_isc_aa <- as.Date(imprese$data_isc_aa)
imprese$data_isc_rd <- as.Date(imprese$data_isc_rd)
imprese$data_isc_ri <- as.Date(imprese$data_isc_ri)
imprese$data_ini_at <- as.Date(imprese$data_ini_at)
imprese$data_min    <- as.Date(imprese$data_isc_rd)

```


#imprese %>% mutate(data_min = coalesce(data_min, data_ini_at)) #verificare se funziona come previsto
#imprese %>% mutate(data_min = coalesce(data_min,data_isc_aa))
#imprese %>% mutate(data_min = coalesce(data_min,data_isc_rd))
#imprese %>% mutate(data_min = coalesce(data_min,data_isc_ri))

```{r}
imprese$data_min <- as.Date(imprese$data_min)
imprese <- imprese[!grepl('INATTIVA', imprese$stato_impresa),]

imprese <- imprese[complete.cases(imprese$data_min), ] #elimina le righe con NA in data_min

imprese$eta = as.numeric(as.Date("2022-01-01") - imprese$data_min) / 365  #calcola età
imprese <- imprese[complete.cases(imprese$eta), ] 
eta <- imprese$eta


```



```{r}
boxplot(imprese$eta, imprese$imp_giovanile)
ggplot(data=imprese, aes(x=eta, fill = imp_startup)) + geom_histogram(breaks=seq(0, 100, by=1))
```

 
 
```{r}
ggplot(data=imprese, aes(x=eta, fill = imp_femminile)) + geom_histogram(breaks=seq(0, 100, by=5))

```
 
 
```{r}
imprese2 <-subset(imprese,capitale_valuta == "EURO")
imprese2 <-subset(imprese2,capitale < 1e6)
imprese2 <-subset(imprese2,ng2 == "SP")


boxplot(imprese2$capitale)
qplot(imprese2$capitale, geom="histogram")
```


```{r}


imprese<- subset(imprese2, select = c('eta', 'cf', 'id_impresa') )
ids <- unique(imprese2$id_impresa)
setwd("./../../../_DATA/infocamere")
localiz <- read.csv("t_localizz.csv", sep = "|")
localiz <- localiz[localiz$id_impresa %in% ids,]
localiz <- subset(localiz, select = c('id_impresa', 'id_localiz'))
locs <- unique(localiz$id_localiz)
codici <- read.csv("t_codici.csv", sep = "|")
codici <- codici[codici$id_localiz %in% locs,]
codici <- subset(codici, select = c('id_localiz', 'ateco'))

codici = merge(codici, localiz, by = "id_localiz")

imp <- data.frame("company"=ids)
imp$eta <- imprese$eta
imp$ateco <- NA

#aggiunge al data.frame una lista di codici ateco
for (impresa in imp$company){
        temp = as.list(subset(codici, id_impresa == impresa))
        unique_nace_codes <- unique(temp$ateco)
        rownum = which(imp$company == impresa)
        imp$ateco[rownum] <- list(unique_nace_codes)
}


```
## A similarity function between companies based on NACE codes 

```{r}

splitnace <- function(nace){
  if (length(nace) == 0 ){
    #print('some issues with nace code!')
    #print(nace)
    return(c("00.00.00"))}
  result = strsplit(nace,"[.]",fixed = TRUE)
  return(result)
}

distance <- function(nace1, nace2, d=0){
  ln1=length(nace1)
  ln2=length(nace2)
  
  w = c(0.25,0.15,0.1)
  #pesi da assegnare alle distanze a seconda della profondità dell'albero
  #TODO rivedere i pesi: se appartengono a due macrosettori diversi il peso è 1
  # e a quel punto se d>=1 puoi uscire
  
  if (ln1 == ln2){
    if (identical (nace1, nace2)){
      return(min(d,1))
    }else{
      return (distance (head(nace1,-1), head(nace2, -1), d+2*w[ln1]))
    }    
    
  }else{
    if (ln1 > ln2){
      return (distance (head(nace1, -1), nace2, d+w[ln1]))
    }else{
      return (distance (nace1, head(nace2, -1), d+w[ln2]))
    }  
  }
}


pairwise_distance <- function(id_imp_1, id_imp_2, imp){
        naces_imp_1 <- unlist(imp[id_imp_1, 3], recursive = TRUE)
        naces_imp_2 <- unlist(imp[id_imp_2, 3], recursive = TRUE)
        #print('##')
        #print(id_imp_1)
        #print(id_imp_2)
        #print(naces_imp_1)
        #print(naces_imp_2)
        dist_list <-0
        l1 <-  length(naces_imp_1)
        l2 <-  length(naces_imp_2)
        for (ci in 1:l1){
                for (cj in 1:l2){
                        n1 = unlist(splitnace(naces_imp_1[ci]))
                        n2 = unlist(splitnace(naces_imp_2[cj]))
                        #print(n1)
                        #print(n2)
                        
                        d = distance(n1, n2, 0)
                        dist_list <- c(dist_list, d)

                        #print(dist_list)

                 }
        }
        return(dist_list)
}


dd <- pairwise_distance(which(imp$company == 1020), which(imp$company == 1036), imp)
mean(dd)


#TODO: nest into a loop to scan pairwise distances between companies
someids=ids[1:20]

distances<-c(0)
for (id in someids){
        #print('*******************new id**')
        #print(id)
        distances <- c(distances, mean(pairwise_distance(
                        which(imp$company == 222), 
                        which(imp$company == id),
                        imp)))
}

for (k in 1:20){
  neibs = order(distances)[1:k]
  dist_neibs = mean(distances[neibs])
  print(dist_neibs)# mean distance of k nearest neighbours
}
boxplot(distances)

library(ggplot2)
qplot(distances, geom="histogram", binwidth=.005)

```
