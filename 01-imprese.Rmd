---
output:
  pdf_document: default
  html_document: default
---
# Exploring dataset "companiesFVG" 
 

```{r include=FALSE}
# Local path, no need to display in knitted version
pathRawData = './../../_data/raw/imprese'
pathTidyData = './../../_data/tidy/'
library("tidyverse")
```
 
The dataset is organizes in a number of files; each file will be loaded in a different _data.frame_. 
 
```{r}
data.files <- list.files(pathRawData, pattern = ".csv$", recursive = TRUE)
print(paste("dataset contains",length(data.files), "files:"))
print(data.files)
```
## companies
The core data identifying companies can be found in *t_imprese.csv* . 
```{r}
companies <- read_delim( paste0(pathRawData,"/t_imprese.csv")) 
spec(companies) # tydiverse for str(companies)
 
```
The attributes belong to different groups: 

- *metadata*:ï..fonte, mm_aaaa: 
- *identifier*: id_impresa,reg_imp_n, cf, piva, denominazione 
- *address*:prov,sede_ul,n.albo_art,reg_imp_sez  
- *type of company*: ng2
- *active status*: stato_impresa  
- *dates*:data_ini_at, data_cess_att, data_fall, data_liquid, data_cost, data_isc_ri, data_isc_rd,data_isc_aa,data_canc
- *employees*:  addetti_aaaa, addetti_indip, addetti_dip  
- *share capital*: capitale, capitale_valuta 
- *other attributes*: imp_startup, imp_femminile, imp_giovanile, imp_straniera,  imp_pmi, imp_sedi_ee, imp_eefvg 

### Metadata
Metadata are generated by the pre-rpcessing algorithm and provide information about source and last update.
The two attributes (ï..fonte, mm_aaaa) are not relevant at this stage. 
```{r}
companies <- companies %>% select( !c(fonte, mm_aaaa))
#same as subset(companies, select = -c(ï..fonte, mm_aaaa))
```

### Identifiers
The following attributes are relevant: 
- denominazione: company name
- cf ("codice fiscale"): unique identifier, as factor (11 numbers or a string of 16 lettersa nd numbers)
- id_impresa: unique identifier, numeric.
Id and cf are unique, while company names are not and there are no missing values.
Other attributes (reg_imp_n,piva, n.albo_art,reg_imp_sez) are not relevant at this stage, and can be dropped. 

> TOTO the name of attribute `n-albo_art`should not contain "-"


```{r}
companies <- companies %>% 
             select( !c(reg_imp_n, piva, `n-albo_art`,reg_imp_sez)) %>% 
             rename(name = denominazione) %>%
             rename(idCompany = id_impresa) %>%
             mutate_if(is.character, as.factor) 

```

Now we can ckeck if there are any missing values or duplicates
```{r}

# check missing calues
sum(is.na(companies$name)) + sum(is.na(companies$cf)) == 0
# check duplicates in cf
length(unique(companies$cf)) == length(companies$cf)
# check duplicates in name
uniqueNames <-length(unique(companies$name)) 
allNames<-length(companies$name)
print(paste("Company names are not a valid identifier for further analysis: the dataset contains", uniqueNames, "distinct names out of", allNames, "companies. There are", (allNames-uniqueNames), "duplicates."),quote = FALSE)
```

### active status
Companies that are not active (e.g. due to bankruptcy, liquidation or suspended) are not relevant for the research objectives and can be removed from the dataset. 

```{r}
df<-companies %>% count(stato_impresa) 
ggplot(data=df, aes(x=stato_impresa, y=n)) +   geom_bar(stat="identity") + coord_flip()
companies <- subset(companies, stato_impresa =='ATTIVA')
print(paste("Number of active companies: ", nrow(companies)), quote=FALSE)
```

### location
Each company has a "registered office" (sede legale) and may have several local units (unità locale). Relevant data is stored in file "t_localizz.csv".
> TODO: add description of variables. Select only companies that are located in Friuli Venezia Giulia, according to prov: province (GO, TS, UD, PN). Select companies that have head office abroad.
sede_ul: "SEDE" or "UL-n" >> factor SEDE = HeadOffice / UL = LocalUnit
Extract the number of local units from attribute "sede_ul"
Create new variable "head-office" true/false 
use "data apertura ul" to improve the estimate of company age (or remove the attribute)
remove unnecessary variables


```{r}
locs <- read_delim( paste0(pathRawData,"/t_localizz.csv")) %>%
             select( c(id_localiz, id_impresa, denominazione,tipo_localizzazione)) %>% 
             rename(name = denominazione) %>%
             rename(idCompany = id_impresa) %>%
             mutate_if(is.character, as.factor) 
```

### type of company

> TODO: add text. improve code with tidyverse

```{r}
# company type: keep only the relevan ones for the scope of our research.
types <- read.csv( paste0(pathRawData,"/d_ng.csv"), sep = "|")
companies$ng2           <- as.factor(companies$ng2)
names(types)<-c("ngGroup", "ng2", "ngDescription")

df <- companies  %>% count(ng2) 
df <- df %>% inner_join(types)
df <- df  %>% arrange(-n) %>% head(20)
df$ngDescription <- factor(df$ngDescription, levels = df$ngDescription) #lock factors to keep the same order in the bar plot
ggplot(data=df, aes(x=ngDescription, y=n)) +   geom_bar(stat="identity") + coord_flip()

```
Some company types are not relevant for our research, for example individual companies (DI) and other specified below. Dropping the corresponding dataframe rows drastically reduces the size of the data set
```{r}
notRelevant = c("DI", "AZ", "IR", "ER", "EP", "EN", "EM", "EL", "EE", "SM", "MA", "SZ", "LL", "AM", "AF")
toBeRemoved<-which(companies$ng2 %in% notRelevant)
companies2<-companies[-toBeRemoved,]
print(nrow(companies2))

df <- companies2  %>% count(ng2) 
print(paste("The dataset contains ", nrow(df), "types of companies."), quote=FALSE)
df <- df %>% inner_join(types)
df <- df  %>% arrange(-n) 
df$ngDescription <- factor(df$ngDescription, levels = df$ngDescription) #lock factors to keep the same order in the bar plot
ggplot(data=head(df, 10), aes(x=ngDescription, y=n))  + geom_bar(stat="identity", color = "black", fill = "lightblue") + coord_flip() + ggtitle("Most common types") + geom_text(aes(x=ngDescription, y=n, label = n, hjust = -.2), color = "black") + ylim(NA, 22000)

```
### dates, age of companies, years in business
The dataset provides several dates: start of activity, dates of bankarupcy and cancellation
We are interested in a broader information: "years in business"

Information on bankarupcy should be redundant, since non-active companies have been removed; nevertheless, past check showed unconistend data in the original tables. If bancarupcy dates are present, the company is considered as non-actie and removed. 

at the end we keep only eta; all data fields can be removed

```{r}
dates <- companies %>% select(starts_with("data"))
tmp <- dates %>% summary(is.na())
tmp
```

```{r}
companies <- companies %>% rowwise() %>% 
            mutate(MinDate = min(data_isc_ri, data_isc_rd, data_isc_aa, data_ini_at,  na.rm=TRUE)) %>%
            mutate(yearsInBusiness = as.numeric(as.Date("2022-01-01") - MinDate) / 365  )

tmp <- companies %>% select(starts_with("data")) %>% summary(is.na())
 
boxplot(companies$yearsInBusiness)
ggplot(data=companies, aes(x=yearsInBusiness, fill = "red")) + geom_histogram(breaks=seq(0, 100, by=1))


```

> TODO remove c(data_ini_at, data_cess_att, data_fall, data_liquid, data_cost, data_isc_ri, data_isc_rd,data_isc_aa,data_canc)

### employees
addetti_aaaa, addetti_indip, addetti_dip  

### share capital
capitale, capitale_valuta 

### other attributes
> TODO other attributes are relevant as signs of innovation
imp_startup, imp_femminile, imp_giovanile, imp_straniera,  imp_pmi, imp_sedi_ee, imp_eefvg  
show distribution for each

```{r}
companies$imp_pmi       <- as.factor(companies$imp_pmi)
companies$imp_startup   <- as.factor(companies$imp_startup)
companies$imp_giovanile <- as.factor(companies$imp_giovanile)
companies$imp_femminile <- as.factor(companies$imp_femminile)
companies$imp_straniera <- as.factor(companies$imp_straniera)
companies$imp_sedi_ee   <- as.factor(companies$imp_sedi_ee)
```


Now we can save clean data to csv
```{r}
companies %>% write_csv(paste0(pathTidyData,"cmp.csv"),)
```


## Codici
Each company is associated with a list of activity codes, according to NACE classification.
The corresponding information is available in *t_codici.csv* . As in previous files, metadata can be inored at this stage.
More info: Complete list of all NACE Code
NACE (Nomenclature of Economic Activities) is the European statistical classification of economic activities. NACE groups organizations according to their business activities.
[https://nacev2.com/en]
 

> TODO nace codes are associated with a company and each of its localizations. We may be interesed in reducin the compexity, summarizing all codes, and ignoring association to each location. But this can be an issue in some cases. For example a company has its head office in Rome, with some codes, and a local unit in Trieste engaged in different activities. Shall we consider all the codes, or by location?
> TODO Some companies have no nace codes associated: how many? should we drop the corresponding row in companies?
> TODO Explore code types (I P S) they are not unique.


<!--  ```{r} -->
<!-- naceCodes <- read.csv( paste0(pathRawData,"/t_codici.csv"), sep = "|")  %>%  -->
<!--   select(-c(ï..fonte, mm_aaaa)) %>%         #ignore metadata -->
<!--   filter(ateco != "") %>%                 # drop rows with empty nace codes -->
<!--   inner_join(locs, by="id_localiz") %>% -->
<!--   select(-c(data_apert_ul, comune, indirizzo, tipo_sedeul)) -->

<!-- naceCodes["sector"]<-substr(naceCodes$ateco,start=1,stop=2) -->
<!-- str(naceCodes) -->
<!-- ``` -->
<!-- Not all sectors are relevant for the research topic. We can restrict the dataset to manufacturing activities (codes 10 to 33)and research (sector = 72) -->

<!--  ```{r} -->

<!-- relevantSectors <- seq(10,33)  -->
<!-- relevantSectors <- c(relevantSectors,72)  -->
<!-- relevantSectors -->

<!-- naceCodes <- naceCodes %>% filter(sector %in% relevantSectors)      #filtering codes -->
<!-- companies <- companies %>% filter(id_impresa %in% naceCodes$id_impresa) #filtering companies -->

<!-- print(paste("Number of companies reduced to ", nrow(companies))) -->

<!-- ``` -->

 
 
 



<!--  ```{r} -->
<!-- companies2 <-subset(companies,capitale_valuta == "EURO") -->
<!-- companies2 <-subset(companies2,capitale < 1e6) -->
<!-- companies2 <-subset(companies2,ng2 == "SP") -->


<!-- boxplot(companies2$capitale) -->
<!-- qplot(companies2$capitale, geom="histogram") -->
<!-- ``` -->


<!--  ```{r} -->


<!-- companies<- subset(companies2, select = c('eta', 'cf', 'id_impresa') ) -->
<!-- ids <- unique(companies2$id_impresa) -->
<!-- localiz <- read.csv("t_localizz.csv", sep = "|") -->
<!-- localiz <- localiz[localiz$id_impresa %in% ids,] -->
<!-- localiz <- subset(localiz, select = c('id_impresa', 'id_localiz')) -->
<!-- locs <- unique(localiz$id_localiz) -->
<!-- codici <- read.csv("t_codici.csv", sep = "|") -->
<!-- codici <- codici[codici$id_localiz %in% locs,] -->
<!-- codici <- subset(codici, select = c('id_localiz', 'ateco')) -->

<!-- codici = merge(codici, localiz, by = "id_localiz") -->

<!-- imp <- data.frame("company"=ids) -->
<!-- imp$eta <- companies$eta -->
<!-- imp$ateco <- NA -->

<!-- #aggiunge al data.frame una lista di codici ateco -->
<!-- for (impresa in imp$company){ -->
<!--         temp = as.list(subset(codici, id_impresa == impresa)) -->
<!--         unique_nace_codes <- unique(temp$ateco) -->
<!--         rownum = which(imp$company == impresa) -->
<!--         imp$ateco[rownum] <- list(unique_nace_codes) -->
<!-- } -->

<!-- " -->
<!-- '''" -->

