---
output:
  pdf_document: default
  html_document: default
---
# Exploring dataset "impreseFVG" {-}
 

```{r include=FALSE}
# Local path, no need to display in knitted version
path = './../../_DATA/imprese'
library("tidyverse")
```
 
The dataset is organizes in a number of files; each file will be loaded in a different _data.frame_. 
 
```{r}
data.files <- list.files(path, pattern = ".csv$", recursive = TRUE)
print(paste("dataset contains",length(data.files), "files:"))
print(data.files)
```
## imprese
The core data identifying companies can be found in *t_imprese.csv* . 
```{r}
imprese <- read.csv( paste0(path,"/t_imprese.csv"), sep = "|")
str(imprese)
 
```
The attributes belong to different groups: 

- *metadata*:ï..fonte, mm_aaaa: 
- *identifier*: id_impresa,reg_imp_n, cf, piva, denominazione 
- *address*:prov,sede_ul,n.albo_art,reg_imp_sez  
- *type of company*: ng2
- *active status*: stato_impresa  
- *dates*:data_ini_at, data_cess_att, data_fall, data_liquid, data_cost, data_isc_ri, data_isc_rd,data_isc_aa,data_canc
- *employees*:  addetti_aaaa, addetti_indip, addetti_dip  
- *share capital*: capitale, capitale_valuta 
- *other attributes*: imp_startup, imp_femminile, imp_giovanile, imp_straniera,  imp_pmi, imp_sedi_ee, imp_eefvg 

### Metadata
Metadata are generated by the pre-rpcessing algorithm and provide information about source and last update.
The two attributes (ï..fonte, mm_aaaa) are not relevant at this stage. 
```{r}
imprese <- subset(imprese, select = -c(ï..fonte, mm_aaaa))

```

### Identifiers
The following attributes are relevant: 
- denominazione: company name
- cf ("codice fiscale"): unique identifier, as factor (11 numbers or a string of 16 lettersa nd numbers)
- id_impresa: unique identifier, numeric.
Id and cf are unique, while company names are not and there are no missing values.

```{r}
imprese$cf <- as.factor(imprese$cf)
imprese$denominazione <- as.factor(imprese$denominazione)
# check missing calues
sum(is.na(imprese$denominazione)) + sum(is.na(imprese$cf)) == 0
# check duplicates in cf
length(unique(imprese$cf)) == length(imprese$cf)
# check duplicates in denominazione
uniqueNames <-length(unique(imprese$denominazione)) 
allNames<-length(imprese$denominazione)
print(paste("Company names are not a valid identifier for further analysis: the dataset contains", uniqueNames, "distinct names out of", allNames, "companies. There are", (allNames-uniqueNames), "duplicates."),quote = FALSE)

```
Other attributes (reg_imp_n,piva, n.albo_art,reg_imp_sez) are not relevant at this stage, and can be dropped. 

```{r}
imprese <- subset(imprese, select = -c(reg_imp_n,piva, n.albo_art,reg_imp_sez))

```


### active status
Companies that are not active (e.g. due to bankruptcy, liquidation or suspended) are not relevant for the research objectives and can be removed from the dataset. 

```{r}
imprese$stato_impresa <- as.factor(imprese$stato_impresa)
df<-imprese %>% count(stato_impresa)  
ggplot(data=df, aes(x=stato_impresa, y=n)) +   geom_bar(stat="identity") + coord_flip()
imprese<- subset(imprese, stato_impresa =='ATTIVA')
print(paste("Number of active companies: ", nrow(imprese)), quote=FALSE)
```

### location
> TODO 
prov: province (GO, TS, UD, PN) >> factor FVG / ITA / EU
sede_ul: "SEDE" or "UL-n" >> factor SEDE = HeadOffice / UL = LocalUnit
LucalUnit = numeric 0 for HeadOffice, otherwise n
To be transformed in factors

```{r}
locs <- read.csv( paste0(path,"/t_localizz.csv"), sep = "|")
locs <- subset(locs, select = -c(ï..fonte))#ignore metadata
#connect to company id
str(locs)
```

### type of company

> TODO: use ng2


```{r}
# company type: keep only the relevan ones for the scope of our research.
types <- read.csv( paste0(path,"/d_ng.csv"), sep = "|")
imprese$ng2           <- as.factor(imprese$ng2)
names(types)<-c("ngGroup", "ng2", "ngDescription")

df <- imprese  %>% count(ng2) 
df <- df %>% inner_join(types)
df <- df  %>% arrange(-n) %>% head(20)
df$ngDescription <- factor(df$ngDescription, levels = df$ngDescription) #lock factors to keep the same order in the bar plot
ggplot(data=df, aes(x=ngDescription, y=n)) +   geom_bar(stat="identity") + coord_flip()

```
Some company types are not relevant for our research, for example individual companies (DI) and other specified below. Dropping the corresponding dataframe rows drastically reduces the size of the data set
```{r}
notRelevant = c("DI", "AZ", "IR", "ER", "EP", "EN", "EM", "EL", "EE", "SM", "MA", "SZ", "LL", "AM", "AF")
toBeRemoved<-which(imprese$ng2 %in% notRelevant)
imprese2<-imprese[-toBeRemoved,]
print(nrow(imprese2))

df <- imprese2  %>% count(ng2) 
print(paste("The dataset contains ", nrow(df), "types of companies."), quote=FALSE)
df <- df %>% inner_join(types)
df <- df  %>% arrange(-n) 
df$ngDescription <- factor(df$ngDescription, levels = df$ngDescription) #lock factors to keep the same order in the bar plot
ggplot(data=head(df, 10), aes(x=ngDescription, y=n))  + geom_bar(stat="identity", color = "black", fill = "lightblue") + coord_flip() + ggtitle("Most common types") + geom_text(aes(x=ngDescription, y=n, label = n, hjust = -.2), color = "black") + ylim(NA, 22000)

```
### dates, age of companies, years in business
The dataset provides several dates: start of activity, dates of bankarupcy and cancellation
We are interested in a broader information: "years in business"

Information on bankarupcy should be redundant, since non-active companies have been removed; nevertheless, past check showed unconistend data in the original tables. If bancarupcy dates are present, the company is considered as non-actie and removed. 

at the end we keep only eta; all data fields can be removed
```{r}
imprese$data_cost   <- as.Date(imprese$data_cost)
imprese$data_isc_aa <- as.Date(imprese$data_isc_aa)
imprese$data_isc_rd <- as.Date(imprese$data_isc_rd)
imprese$data_isc_ri <- as.Date(imprese$data_isc_ri)
imprese$data_ini_at <- as.Date(imprese$data_ini_at)

sum(is.na(imprese$data_isc_aa))
sum(is.na(imprese$data_isc_rd))
sum(is.na(imprese$data_isc_ri))
sum(is.na(imprese$data_ini_at))

#imprese %>% mutate(data_min = min(data_isc_aa, data_isc_rd, data_isc_ri, data_ini_at)) 
imprese["data_min"]<-imprese$data_isc_rd
sum(is.na(imprese$data_min))
imprese <- imprese[complete.cases(imprese$data_min), ] 
imprese["eta"] = as.numeric(as.Date("2022-01-01") - imprese$data_min) / 365  #calcola età
imprese <- imprese[complete.cases(imprese$eta), ]
imprese <- imprese %>% 
  select(-c(data_isc_aa, data_isc_rd, data_isc_ri, data_ini_at)) 

# TODO: select the minumum date
# %>%
#   filter(data_fall != "")     %>%                 # drop unconsistent rows
#   filter(data_liquid != "")   %>%                 # drop unconsistent rows
#   filter(data_cess_att != "") %>%                 # drop unconsistent rows
#   filter(data_canc != "")                         # drop unconsistent rows
```

#TODO
#imprese %>% mutate(data_min = coalesce(data_min, data_ini_at)) #verificare se funziona come previsto
#imprese %>% mutate(data_min = coalesce(data_min,data_isc_aa))
#imprese %>% mutate(data_min = coalesce(data_min,data_isc_rd))
#imprese %>% mutate(data_min = coalesce(data_min,data_isc_ri))


```{r}
eta <- imprese$eta
boxplot(imprese$eta)
ggplot(data=imprese, aes(x=eta, fill = imp_startup)) + geom_histogram(breaks=seq(0, 100, by=1))
```



 ```{r}
ggplot(data=imprese, aes(x=eta, fill = imp_femminile)) + geom_histogram(breaks=seq(0, 100, by=5))

```

> TODO use all "start dates" to get a better estimate of _years in business_ 

*:data_ini_at, data_cess_att, data_fall, data_liquid, data_cost, data_isc_ri, data_isc_rd,data_isc_aa,data_canc

### employees
addetti_aaaa, addetti_indip, addetti_dip  

### share capital
capitale, capitale_valuta 

### other attributes
> TODO other attributes are relevant as signs of innovation
imp_startup, imp_femminile, imp_giovanile, imp_straniera,  imp_pmi, imp_sedi_ee, imp_eefvg  
show distribution for each

```{r}
imprese$imp_pmi       <- as.factor(imprese$imp_pmi)
imprese$imp_startup   <- as.factor(imprese$imp_startup)
imprese$imp_giovanile <- as.factor(imprese$imp_giovanile)
imprese$imp_femminile <- as.factor(imprese$imp_femminile)
imprese$imp_straniera <- as.factor(imprese$imp_straniera)
imprese$imp_sedi_ee   <- as.factor(imprese$imp_sedi_ee)
```


## Codici
Each company is associated with a list of activity codes, according to NACE classification.
The corresponding information is available in *t_codici.csv* . As in previous files, metadata can be inored at this stage.
More info: Complete list of all NACE Code
NACE (Nomenclature of Economic Activities) is the European statistical classification of economic activities. NACE groups organizations according to their business activities.
[https://nacev2.com/en]
 

> TODO nace codes are associated with a company and each of its localizations. We may be interesed in reducin the compexity, summarizing all codes, and ignoring association to each location. But this can be an issue in some cases. For example a company has its head office in Rome, with some codes, and a local unit in Trieste engaged in different activities. Shall we consider all the codes, or by location?
> TODO Some companies have no nace codes associated: how many? should we drop the corresponding row in imprese?
> TODO Explore code types (I P S) they are not unique.


```{r}
naceCodes <- read.csv( paste0(path,"/t_codici.csv"), sep = "|")  %>% 
  select(-c(ï..fonte, mm_aaaa)) %>%         #ignore metadata
  filter(ateco != "") %>%                 # drop rows with empty nace codes
  inner_join(locs, by="id_localiz") %>%
  select(-c(data_apert_ul, comune, indirizzo, tipo_sedeul))

naceCodes["sector"]<-substr(naceCodes$ateco,start=1,stop=2)
str(naceCodes)
```
Not all sectors are relevant for the research topic. We can restrict the dataset to manufacturing activities (codes 10 to 33)and research (sector = 72)

```{r}

relevantSectors <- seq(10,33) 
relevantSectors <- c(relevantSectors,72) 
relevantSectors

naceCodes <- naceCodes %>% filter(sector %in% relevantSectors)      #filtering codes
imprese <- imprese %>% filter(id_impresa %in% naceCodes$id_impresa) #filtering companies

print(paste("Number of companies reduced to ", nrow(imprese)))

```

 
 
 



<!--  ```{r} -->
<!-- imprese2 <-subset(imprese,capitale_valuta == "EURO") -->
<!-- imprese2 <-subset(imprese2,capitale < 1e6) -->
<!-- imprese2 <-subset(imprese2,ng2 == "SP") -->


<!-- boxplot(imprese2$capitale) -->
<!-- qplot(imprese2$capitale, geom="histogram") -->
<!-- ``` -->


<!--  ```{r} -->


<!-- imprese<- subset(imprese2, select = c('eta', 'cf', 'id_impresa') ) -->
<!-- ids <- unique(imprese2$id_impresa) -->
<!-- localiz <- read.csv("t_localizz.csv", sep = "|") -->
<!-- localiz <- localiz[localiz$id_impresa %in% ids,] -->
<!-- localiz <- subset(localiz, select = c('id_impresa', 'id_localiz')) -->
<!-- locs <- unique(localiz$id_localiz) -->
<!-- codici <- read.csv("t_codici.csv", sep = "|") -->
<!-- codici <- codici[codici$id_localiz %in% locs,] -->
<!-- codici <- subset(codici, select = c('id_localiz', 'ateco')) -->

<!-- codici = merge(codici, localiz, by = "id_localiz") -->

<!-- imp <- data.frame("company"=ids) -->
<!-- imp$eta <- imprese$eta -->
<!-- imp$ateco <- NA -->

<!-- #aggiunge al data.frame una lista di codici ateco -->
<!-- for (impresa in imp$company){ -->
<!--         temp = as.list(subset(codici, id_impresa == impresa)) -->
<!--         unique_nace_codes <- unique(temp$ateco) -->
<!--         rownum = which(imp$company == impresa) -->
<!--         imp$ateco[rownum] <- list(unique_nace_codes) -->
<!-- } -->

<!-- " -->
<!-- '''" -->

